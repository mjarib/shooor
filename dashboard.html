<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم الخبير | شـــووور</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <style>body { font-family: 'Tajawal', sans-serif; }</style>
</head>
<body class="bg-slate-50 text-slate-900">

    <header class="bg-blue-900 text-white py-6 px-6 shadow-lg">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-black tracking-tighter italic">لوحة تحكم الخبير</h1>
            <button onclick="window.location.href='index.html'" class="bg-white/10 px-4 py-2 rounded-xl text-xs font-bold border">العودة للموقع</button>
        </div>
    </header>

    <main class="max-w-4xl mx-auto py-10 px-6">
        <h2 class="text-xl font-black text-blue-900 mb-8">الطلبات الواردة</h2>
        <div id="requests-container" class="space-y-4"></div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAZSFCf7piwKykf_klgGlzc4RkCXumNRUg",
            authDomain: "shooor-app.firebaseapp.com",
            projectId: "shooor-app",
            storageBucket: "shooor-app.firebasestorage.app",
            messagingSenderId: "356426973132",
            appId: "1:356426973132:web:6353917bf13a64074d6769"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function listenToRequests() {
            db.collection("consultations")
                .where("status", "in", ["pending", "paid"])
                .orderBy("createdAt", "desc")
                .onSnapshot((snapshot) => {
                    const container = document.getElementById('requests-container');
                    container.innerHTML = '';
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const id = doc.id;
                        
                        if(data.status === 'pending') {
                            container.innerHTML += `
                                <div class="bg-white p-6 rounded-2xl shadow-sm border flex justify-between items-center">
                                    <div>
                                        <h3 class="font-black text-blue-900">${data.userName}</h3>
                                        <p class="text-xs text-slate-400 font-bold">يطلب استشارتك الآن</p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="updateStatus('${id}', 'approved')" class="bg-green-500 text-white px-6 py-2 rounded-xl font-black text-xs">قبول</button>
                                        <button onclick="updateStatus('${id}', 'rejected')" class="bg-red-50 text-red-500 px-6 py-2 rounded-xl font-black text-xs">رفض</button>
                                    </div>
                                </div>`;
                        } else if(data.status === 'paid') {
                            container.innerHTML += `
                                <div class="bg-blue-900 text-white p-6 rounded-2xl shadow-sm flex justify-between items-center animate-pulse">
                                    <div>
                                        <h3 class="font-black">${data.userName} (تم الدفع)</h3>
                                        <p class="text-xs opacity-70">المستخدم بانتظارك في غرفة الدردشة</p>
                                    </div>
                                    <button onclick="goToChat('${id}', '${data.expertName}')" class="bg-orange-500 text-white px-6 py-2 rounded-xl font-black text-xs shadow-lg">دخول الغرفة</button>
                                </div>`;
                        }
                    });
                });
        }

        async function updateStatus(id, status) {
            await db.collection("consultations").doc(id).update({ status: status });
        }

        function goToChat(id, expert) {
            window.location.href = `chat.html?requestId=${id}&expert=${encodeURIComponent(expert)}`;
        }

        listenToRequests();
    </script>
</body>
</html>
