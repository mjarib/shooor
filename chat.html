<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8"><script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body class="bg-slate-100 font-['Tajawal'] h-screen flex flex-col">
    <nav class="bg-blue-900 text-white p-4 flex justify-between items-center">
        <div class="font-black">محادثة الشور</div>
        <div id="timer" class="bg-orange-500 px-4 py-1 rounded-full font-black text-sm">30:00</div>
    </nav>
    <div id="msgBox" class="flex-1 overflow-y-auto p-6 space-y-4"></div>
    <div class="p-4 bg-white border-t flex gap-2">
        <input type="text" id="mIn" placeholder="اكتب استفسارك هنا..." class="flex-1 p-4 bg-slate-50 rounded-2xl outline-none">
        <button onclick="send()" class="bg-blue-900 text-white px-8 rounded-2xl font-black italic">إرسال</button>
    </div>
    <div id="rateModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-6">
        <div class="bg-white p-10 rounded-[3rem] w-full max-w-sm text-center">
            <h2 class="text-2xl font-black mb-6">كيف كانت تجربتك؟</h2>
            <div class="flex justify-center gap-2 mb-8 text-4xl">
                <button onclick="rate(1)">⭐</button><button onclick="rate(2)">⭐</button><button onclick="rate(3)">⭐</button><button onclick="rate(4)">⭐</button><button onclick="rate(5)">⭐</button>
            </div>
            <p class="text-xs text-slate-400 font-bold">رأيك يهمنا لتحسين جودة الشور</p>
        </div>
    </div>
    <script src="config.js"></script>
    <script>
        const bid = new URLSearchParams(window.location.search).get('bid');
        let time = 1800;
        setInterval(() => {
            if(time <= 0) { document.getElementById('rateModal').classList.remove('hidden'); return; }
            time--; let m = Math.floor(time/60), s = time%60;
            document.getElementById('timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
        }, 1000);
        async function send() {
            const u = auth.currentUser, m = document.getElementById('mIn').value;
            if(!m) return;
            await db.collection("bookings").doc(bid).collection("chats").add({ u: u.displayName, m, t: new Date() });
            document.getElementById('mIn').value = '';
        }
        db.collection("bookings").doc(bid).collection("chats").orderBy("t").onSnapshot(s => {
            const b = document.getElementById('msgBox'); b.innerHTML = '';
            s.forEach(d => {
                const isMe = d.data().u === auth.currentUser.displayName;
                b.innerHTML += `<div class="flex ${isMe?'justify-start':'justify-end'}"><div class="${isMe?'bg-blue-900 text-white':'bg-white'} p-4 rounded-2xl max-w-[80%] shadow-sm font-bold text-sm">${d.data().m}</div></div>`;
            });
            b.scrollTop = b.scrollHeight;
        });
        async function rate(n) { alert(`شكراً لتقييمك: ${n} نجوم`); location.href='index.html'; }
    </script>
</body>
</html>
